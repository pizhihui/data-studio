

# 运行总体步骤

### 第一步

执行按钮后
先执行 
1. /api/rest_j/v1/entrance/execute       
2. /api/rest_j/v1/filesystem/saveScript

### 第二步

然后开始轮训状态
1.1 /api/rest_j/v1/entrance/exec_id018028linkis-cg-entrancehadoop01:9104IDE_hadoop_jdbc_1/status?taskID=754
1.2 /api/rest_j/v1/entrance/exec_id018028linkis-cg-entrancehadoop01:9104IDE_hadoop_jdbc_1/progressWithResource
1.3 /api/rest_j/v1/jobhistory/754/get


status接口 返回 `"status": "Succeed",` 状态后,开始显示数据,或者显示异常日志操作


# monaco-editor 组件
关键代码位置: packages/shared/components/editor/editor.vue

获取选择的内容
```js
const selection = this.editor.getSelection();
const sql = selection.isEmpty() ? null : this.editor.getModel().getValueInRange(selection);
```

# 详细解说

### 数据模型
script
```js
{
  running: boolean 
  data:  string
}
```

### 详细步骤:



1. packages/scriptis/module/workbench/script/script.vue


  引入 editor 的代码
 ```
  <editor ref="editor" :script="script" :work="work" :script-type="work.type" :readonly="readonly" 
  @on-save="save" @on-run="run"
        @on-stop="stop"/>
 ```

  580 的 run()方法是主要逻辑 

  主要思路解析
  - 先请求 execute 接口, const data = this.getExecuteData(option);
  - 构建 Execute 对象 this.execute = new Execute(data);
  - 后面就调用 this.execute.start(); 的方法
    - this.execute()
    - httpExecute(); 
    - trigger('execute:queryState')
      - this.queryStatus({ isKill: false })
        - deconstructStatus   /// 轮训状态
          - case 'Succeed'
          - trigger('stateEnd')  -->> this.getResultPath() --> trigger('querySuccess'.xxx) + trigger('getResultList')
          - 
      - this.queryProgress();
    - trigger('steps', 'Inited')
  

2. web/packages/scriptis/module/workbench/script/editor.vue


关键位置: 31行左右, @click.stop="run"

  - 获取到 monaco-editor的运行代码(script): 先通过 editor 获取,不然就是 script.data 内容
  - validateRepeat():  对this.script.params.variable里面是否存在key重复性进行校验
  - 调用 editor 的方法: this.$refs.editor.deltaDecorations
    -  后面的逻辑才会执行 if(lang === 'python' || (app === 'spark' && ['java', 'hql'].indexOf(lang) !== -1) || app === 'hive')
    - 否则就执行回调函数cb
  - 关键步骤: this.$emit('on-run)
  
    引入 we-editor 组件
 ```
 <we-editor
          ref="editor"
          v-model="script.data"
          :language="script.lang"
          :id="script.id"
          :read-only="script.readOnly"
          :script-type="scriptType"
          :file-path="work.filepath || script.id + work.filename"
          :application="script.application"
          type="code"
          @on-operator="heartBeat"
          @on-run="run"
          @on-save="save"
          @is-parse-success="changeParseSuccess"/>
 ```
  run 方法的代码(198行 )
```js
async run() {
      if (this.script.running) return this.$Message.warning(this.$t('message.scripts.editorDetail.warning.running'));
      let selectCode = this.$refs.editor.getValueInRange() || this.script.data;
      let validRepeat = await this.validateRepeat();
      this.$refs.editor.deltaDecorations(selectCode, () => {
        if (!validRepeat) return this.$Message.warning(this.$t('message.scripts.editorDetail.warning.invalidArgs'));
        if (this.loading) return this.$Message.warning(this.$t('message.scripts.constants.warning.api'));
        if (!selectCode) {
          return this.$Message.warning(this.$t('message.scripts.editorDetail.warning.emptyCode'));
        }
        this.loading = true;
        this.$emit('on-run', {
          code: selectCode,
          id: this.script.id,
        }, (status) => {
          // status是start表示已经开始执行
          let list = ['execute', 'error', 'start', 'downgrade'];
          if (list.indexOf(status) > -1) {
            this.loading = false;
          }
        });
      });
    },
```


### 数据展示

代码: packages/scriptis/module/workbench/script/script.vue

```vue
<result
  v-if="bottomTab.show_result"
  ref="result"
  getResultUrl="filesystem"
  :script="script"
  :work="work"
  :dispatch="dispatch"
  :script-view-state="scriptViewState"
  @on-set-change="changeResultSet"/>
```







